<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Eyal Ben-David" />

<meta name="date" content="2017-02-07" />

<title>liftover by realignment in R (liftoveR)</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">liftover by realignment in R (liftoveR)</h1>
<h4 class="author"><em>Eyal Ben-David</em></h4>
<h4 class="date"><em>2017-02-07</em></h4>



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>This vignette describes usage cases for the liftoveR package. The package includes three main modes - stringently aligning closely related sequences (using <em>Bowtie</em>), gapped alignment of related sequences (using <em>Rsubread</em>), aligning across species or highly divergent sequences (using <em>blastn</em>).</p>
<p>The following example dataset will highight each of these use cases.</p>
</div>
<div id="aligning-exon-positions-between-two-builds-of-aspergillus-flavus" class="section level2">
<h2>Aligning exon positions between two builds of Aspergillus Flavus</h2>
<p>For many organisms lifting over a few coordinates from one genome build to another is a simple task, using the liftover tool available in the <em>UCSC genome browser</em>. Alas, we are interested in the pathogenic fungus <em>Aspergillus flavus</em>, for which no build exists in the <em>UCSC genome browser</em>. Luckily, we found a genome build in the <em>Ensembl</em> genome browser. To our dismay, our annotations are made with an old genome build and are incompatible with a newer build that is more used. In this example, we will download both the old and the new reference builds of <em>Asp. flavus</em>, as well as exon coordinates from the old build. We will align them to the new build, and compare the results to the coordinates found in the new annotations.</p>
<div id="step-1-download-old-and-new-genome-builds-and-a-list-of-coordinates-from-the-ensembl-genome-database" class="section level3">
<h3>Step 1: download old and new genome builds, and a list of coordinates from the ensembl genome database</h3>
<p>Letâ€™s download both genomes and extract the fasta files. This can be done using the <em>gunzip</em> function from package <em>R.utils</em>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(R.utils)
<span class="kw">download.file</span>(<span class="st">&quot;ftp://ftp.ensemblgenomes.org/pub/fungi/release-34/fasta/aspergillus_flavus/dna/Aspergillus_flavus.JCVI-afl1-v2.0.dna.toplevel.fa.gz&quot;</span>,<span class="st">&quot;aspFlavusNew.fa.gz&quot;</span>)
<span class="kw">download.file</span>(<span class="st">&quot;ftp://ftp.ensemblgenomes.org/pub/fungi/release-3/fasta/aspergillus_flavus/dna/Aspergillus_flavus.CADRE.55.dna.toplevel.fa.gz&quot;</span>,<span class="st">&quot;aspFlavusOld.fa.gz&quot;</span>)
<span class="kw">gunzip</span>(<span class="st">&quot;aspFlavusOld.fa.gz&quot;</span>)
<span class="kw">gunzip</span>(<span class="st">&quot;aspFlavusNew.fa.gz&quot;</span>)</code></pre></div>
<p>Letâ€™s do the same for gene annotations from both builds. The old build we will use for liftover, the new build for validation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">download.file</span>(<span class="st">&quot;ftp://ftp.ensemblgenomes.org/pub/fungi/release-3/gtf/aspergillus_flavus/Aspergillus_flavus.CADRE.55.gtf.gz&quot;</span>, <span class="st">&quot;aspFlavusOld.gtf.gz&quot;</span>)
<span class="kw">download.file</span>(<span class="st">&quot;ftp://ftp.ensemblgenomes.org/pub/fungi/release-34/gtf/aspergillus_flavus/Aspergillus_flavus.JCVI-afl1-v2.0.34.gtf.gz&quot;</span>,<span class="st">&quot;aspFlavusNew.gtf.gz&quot;</span>)
<span class="kw">gunzip</span>(<span class="st">&quot;aspFlavusOld.gtf.gz&quot;</span>)
<span class="kw">gunzip</span>(<span class="st">&quot;aspFlavusNew.gtf.gz&quot;</span>)</code></pre></div>
</div>
</div>
<div id="step-2-read-in-coordinates-and-match-the-old-annotations-with-the-new-ones" class="section level2">
<h2>Step 2: Read in coordinates and match the old annotations with the new ones</h2>
<p>We will now read in the coordinates of all exons, for the old and the new build. In practice, we will only have one coordinate list, since weâ€™re aligning the exons to the new build. However, for our example, we want to be able to validate our results using the new annotations that we already know. Letâ€™s read in the gtf file. We will acquire the gene names and the exon numbers, and paste them together to create a unique identifier for each exon. This will be done using the <em>stringr</em> package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(stringr)
genesOldCoords =<span class="st"> </span><span class="kw">read.delim</span>(<span class="st">&quot;aspFlavusOld.gtf&quot;</span>,<span class="dt">comment.char =</span>  <span class="st">&quot;#&quot;</span>,<span class="dt">header =</span> F,<span class="dt">as.is =</span> T)
genesOldCoords =<span class="st"> </span>genesOldCoords[genesOldCoords[,<span class="dv">3</span>]==<span class="st">&quot;exon&quot;</span>,]</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(genesOldCoords)</code></pre></div>
<pre><code>##          V1             V2   V3   V4   V5 V6 V7 V8
## 1  EQ963472 protein_coding exon 2977 3107  .  -  .
## 4  EQ963472 protein_coding exon 2688 2922  .  -  .
## 6  EQ963472 protein_coding exon 2316 2620  .  -  .
## 8  EQ963472 protein_coding exon 2168 2260  .  -  .
## 10 EQ963472 protein_coding exon 1996 2106  .  -  .
## 12 EQ963472 protein_coding exon 1863 1942  .  -  .
##                                                                                                                                V9
## 1   gene_id CADAFLAG00000001; transcript_id CADAFLAT00000001; exon_number 1; gene_name AFLA_071780; transcript_name AFLA_071780A;
## 4   gene_id CADAFLAG00000001; transcript_id CADAFLAT00000001; exon_number 2; gene_name AFLA_071780; transcript_name AFLA_071780A;
## 6   gene_id CADAFLAG00000001; transcript_id CADAFLAT00000001; exon_number 3; gene_name AFLA_071780; transcript_name AFLA_071780A;
## 8   gene_id CADAFLAG00000001; transcript_id CADAFLAT00000001; exon_number 4; gene_name AFLA_071780; transcript_name AFLA_071780A;
## 10  gene_id CADAFLAG00000001; transcript_id CADAFLAT00000001; exon_number 5; gene_name AFLA_071780; transcript_name AFLA_071780A;
## 12  gene_id CADAFLAG00000001; transcript_id CADAFLAT00000001; exon_number 6; gene_name AFLA_071780; transcript_name AFLA_071780A;</code></pre>
<p>We need to take the 9th column, and extract the gene name and the exon number. This requires some acrobatics due to the awkward formatting of <em>gtf</em> files. <strong>warning: ugly code ahead</strong>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">geneNamesOld =<span class="st"> </span><span class="kw">str_replace_all</span>(<span class="kw">str_extract</span>(genesOldCoords[,<span class="dv">9</span>],<span class="st">&quot;gene_name+.[A-Z,a-z,0-9,_]*&quot;</span>),<span class="st">&quot;gene_name &quot;</span>,<span class="st">&quot;&quot;</span>)
exonNumberOld =<span class="st"> </span><span class="kw">str_replace_all</span>(<span class="kw">str_extract</span>(genesOldCoords[,<span class="dv">9</span>],<span class="st">&quot;exon_number+.[0-9]*&quot;</span>),<span class="st">&quot;exon_number &quot;</span>,<span class="st">&quot;&quot;</span>)
exonNameAndNumberOld =<span class="st"> </span><span class="kw">paste</span>(geneNamesOld,exonNumberOld,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>)</code></pre></div>
<p>Repeat for the new annotations, those will only be used for validation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">genesNewCoords =<span class="st"> </span><span class="kw">read.delim</span>(<span class="st">&quot;aspFlavusNew.gtf&quot;</span>,<span class="dt">comment.char =</span>  <span class="st">&quot;#&quot;</span>,<span class="dt">header =</span> F,<span class="dt">as.is =</span> T)
genesNewCoords =<span class="st"> </span>genesNewCoords[genesNewCoords[,<span class="dv">3</span>]==<span class="st">&quot;exon&quot;</span>,]
geneNamesNew =<span class="st"> </span><span class="kw">str_replace_all</span>(<span class="kw">str_extract</span>(genesNewCoords[,<span class="dv">9</span>],<span class="st">&quot;gene_id+.[A-Z,a-z,0-9,_]*&quot;</span>),<span class="st">&quot;gene_id &quot;</span>,<span class="st">&quot;&quot;</span>)
exonNumberNew =<span class="st"> </span><span class="kw">str_replace_all</span>(<span class="kw">str_extract</span>(genesNewCoords[,<span class="dv">9</span>],<span class="st">&quot;exon_number+.[0-9]*&quot;</span>),<span class="st">&quot;exon_number &quot;</span>,<span class="st">&quot;&quot;</span>)
exonNameAndNumberNew =<span class="st"> </span><span class="kw">paste</span>(geneNamesNew,exonNumberNew,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>)</code></pre></div>
<p>We can now use this identifier to exclude from the list exons that donâ€™t exist in both annotations, since we wouldnâ€™t be able to validate those.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">exonsInBoth =<span class="st"> </span><span class="kw">intersect</span>(exonNameAndNumberNew,exonNameAndNumberOld)
genesOldCoordsFinal =<span class="st"> </span>genesOldCoords[<span class="kw">match</span>(exonsInBoth,exonNameAndNumberOld),]
genesNewCoordsFinal =<span class="st"> </span>genesNewCoords[<span class="kw">match</span>(exonsInBoth,exonNameAndNumberNew),]</code></pre></div>
</div>
<div id="step-3-liftover-with-rbowtie" class="section level2">
<h2>Step 3: liftoveR with Rbowtie</h2>
<p>We are now ready to align. Letâ€™s align using <em>RBowtie</em>. Note that <em>RBowtie</em> doesnâ€™t allow any gaps in the alignment. This is useful if youâ€™d like to restrict the alignment to highly similar regions between the genome builds, and are more concerned with errors than with losing some regions. Also, it is useful if youâ€™re using Windows, since itâ€™s your only choice at this point.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(liftoveR)
genesOldInNew =<span class="st"> </span><span class="kw">liftover</span>(<span class="dt">chrom =</span> genesOldCoordsFinal[,<span class="dv">1</span>],
         <span class="dt">start =</span> genesOldCoordsFinal[,<span class="dv">4</span>],
         <span class="dt">end =</span> genesOldCoordsFinal[,<span class="dv">5</span>],
         <span class="dt">originalBuild =</span> <span class="st">&quot;aspFlavusOld.fa&quot;</span>,
         <span class="dt">newBuild =</span> <span class="st">&quot;aspFlavusNew.fa&quot;</span>,
         <span class="dt">tmpdir =</span> <span class="kw">getwd</span>(),
         <span class="dt">maxMismatches =</span> <span class="dv">5</span>,
         <span class="dt">aligner=</span><span class="st">&quot;Rbowtie&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;Identified 10795 regions that will need to be split due to size&quot;
## Splitting Reads.....10%..20%..30%..40%..50%..60%..70%..80%..90%..100%nodeNames
## multivac 
##        1 
## [1] &quot;Parsing new start positions based on alignment&quot;
## [1] &quot;Parsing new end positions based on alignment&quot;</code></pre>
<p>The command includes basic elements that are universal to running <em>liftover</em>:</p>
<ul>
<li>chrom: a vector of chromosome names</li>
<li>start: a vector of start positions</li>
<li>end: a vector of end positions</li>
<li>originalBuild: a fasta file from which the sequences will be extracted</li>
<li>newBuild: a fasta file of the new build to align to</li>
<li>aligner: the choice of the aligner to use (Rbowtie,Rsubread or blastn)</li>
</ul>
<p>One thing you can notice is that liftoveR automatically split the regions to allow a maximum length of 500. This is controlled by the parameter <em>maxAllowedLength</em> that defaults to 500, and is important especially when using the short read aligners (<em>Rbowtie</em>, <em>Rsubread</em>) as they could fail when aligning long sequences. <em>liftover</em> automatically splits the reads, aligns, and then patches everything back together to get the start and end positions. Only regions in which all split reads are aligned are returned.</p>
<p>liftover also knows to generate index files automatically for the alignment. These will be generated in the same directory as the genome sequences, <strong>and will not be removed automatically</strong>. Also, in this example, we use the current working directory as the temporary directory. liftover generates input files for alignment from the sequence in the regions, and output bam files are also generated. The default behavior is to use the R temporary directory, so the user doesnâ€™t have to worry about that. Weâ€™ve also set maxMismatches to be 5. This parameter is used differentialy depending on the aligner:</p>
<ul>
<li>Rbowtie - the number of mismatches, as defined by the NM tag in the SAM file generated in the alignment.</li>
<li>Rsubread - the maximum number of mismatches allowed for alignment (defined by maxMismatches parameter of Rsubread)</li>
<li>blastn - <strong>It currently does absolutely nothing in blastn</strong>, since the purpose is to align distantly related features. Alignment parameters for blastn can be provided manually to the function (see the help for <em>liftover</em>)</li>
</ul>
<p>liftover identifies the new regions based on the alignment, and returns everything in a data frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(genesOldInNew)</code></pre></div>
<pre><code>##                   name chrom_orig start_orig end_orig    chrom start  end
## 1 1_EQ963472_2977_3107   EQ963472       2977     3107 EQ963472  2977 3107
## 2 2_EQ963472_2688_2922   EQ963472       2688     2922 EQ963472  2688 2922
## 3 3_EQ963472_2316_2620   EQ963472       2316     2620 EQ963472  2316 2620
## 4 4_EQ963472_2168_2260   EQ963472       2168     2260 EQ963472  2168 2260
## 5 5_EQ963472_1996_2106   EQ963472       1996     2106 EQ963472  1996 2106
## 6 6_EQ963472_1863_1942   EQ963472       1863     1942 EQ963472  1863 1942</code></pre>
<p>The data frame includes the original coordinates and the new coordinates. The order of the table is the same as the inoput, and regions which were not aligned will have NA in the appropriate fields.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(<span class="kw">is.na</span>(genesOldInNew$chrom))</code></pre></div>
<pre><code>## [1] 126</code></pre>
<p>Letâ€™s examine what percent of the exons did we successfuly map</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(genesOldInNew$chrom==genesNewCoords$V1 &amp;genesOldInNew$start==genesNewCoords$V4 &amp;<span class="st"> </span>genesOldInNew$end==genesNewCoords$V5,<span class="dt">na.rm =</span> T) /<span class="st"> </span><span class="kw">nrow</span>(genesOldInNew) *<span class="st"> </span><span class="dv">100</span></code></pre></div>
<pre><code>## [1] 98.3485</code></pre>
<p>How about errors, how many do we have?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(genesOldInNew$chrom!=genesNewCoords$V1 |genesOldInNew$start!=genesNewCoords$V4 &amp;<span class="st"> </span>genesOldInNew$end!=genesNewCoords$V5,<span class="dt">na.rm =</span> T) /<span class="st"> </span><span class="kw">nrow</span>(genesOldInNew) *<span class="st"> </span><span class="dv">100</span></code></pre></div>
<pre><code>## [1] 0.8099195</code></pre>
<p>So in total, we are missing 126 exons, but we managed to map all the rest, with less than 1% error. Failing to align could be a result indels, which RBowtie just canâ€™t handle, multiple mismatches, or even genes which are genuinely omitted from the new build.</p>
</div>
<div id="step-4-liftover-with-rsubread" class="section level2">
<h2>Step 4: liftoveR with Rsubread</h2>
<p>Letâ€™s try again to liftover the regions, this time with Rsubread. Unfortunately, from this point onwards, itâ€™s linux and mac only. This is due to the support of the aligners themselves.</p>
<p>As you can see, we change one parameter, and the function will do the rest.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">genesOldInNew =<span class="st"> </span><span class="kw">liftover</span>(<span class="dt">chrom =</span> genesOldCoordsFinal[,<span class="dv">1</span>],
         <span class="dt">start =</span> genesOldCoordsFinal[,<span class="dv">4</span>],
         <span class="dt">end =</span> genesOldCoordsFinal[,<span class="dv">5</span>],
         <span class="dt">originalBuild =</span> <span class="st">&quot;aspFlavusOld.fa&quot;</span>,
         <span class="dt">newBuild =</span> <span class="st">&quot;aspFlavusNew.fa&quot;</span>,
         <span class="dt">tmpdir=</span><span class="kw">getwd</span>(),
         <span class="dt">maxMismatches =</span> <span class="dv">5</span>,
         <span class="dt">aligner=</span><span class="st">&quot;Rsubread&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(genesOldInNew)</code></pre></div>
<pre><code>##                   name chrom_orig start_orig end_orig    chrom start  end
## 1 1_EQ963472_2977_3107   EQ963472       2977     3107 EQ963472  2977 3107
## 2 2_EQ963472_2688_2922   EQ963472       2688     2922 EQ963472  2688 2922
## 3 3_EQ963472_2316_2620   EQ963472       2316     2620 EQ963472  2316 2620
## 4 4_EQ963472_2168_2260   EQ963472       2168     2260 EQ963472  2168 2260
## 5 5_EQ963472_1996_2106   EQ963472       1996     2106 EQ963472  1996 2106
## 6 6_EQ963472_1863_1942   EQ963472       1863     1942 EQ963472  1863 1942</code></pre>
<p>Letâ€™s repeat our simple tests</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(<span class="kw">is.na</span>(genesOldInNew$chrom))</code></pre></div>
<pre><code>## [1] 46</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(genesOldInNew$chrom==genesNewCoords$V1 &amp;genesOldInNew$start==genesNewCoords$V4 &amp;<span class="st"> </span>genesOldInNew$end==genesNewCoords$V5,<span class="dt">na.rm =</span> T) /<span class="st"> </span><span class="kw">nrow</span>(genesOldInNew) *<span class="st"> </span><span class="dv">100</span></code></pre></div>
<pre><code>## [1] 98.56483</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(genesOldInNew$chrom!=genesNewCoords$V1 |genesOldInNew$start!=genesNewCoords$V4 &amp;<span class="st"> </span>genesOldInNew$end!=genesNewCoords$V5,<span class="dt">na.rm =</span> T) /<span class="st"> </span><span class="kw">nrow</span>(genesOldInNew) *<span class="st"> </span><span class="dv">100</span></code></pre></div>
<pre><code>## [1] 0.8125577</code></pre>
<p>So we fared a bit better, only missing 46 exons, and aligning the rest. We pay for it with a tiny increase in the number of false alignments. Playing with the alignment parameters we can try to resolve this further. One thing we can do is take a larger region for alignment. This is done with the <em>lengthSides</em> argument that controls how much flanking sequence is taken. Also, we can allow more differences using the <em>maxMismatches</em> parameter.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">genesOldInNew =<span class="st"> </span><span class="kw">liftover</span>(<span class="dt">chrom =</span> genesOldCoordsFinal[,<span class="dv">1</span>],
         <span class="dt">start =</span> genesOldCoordsFinal[,<span class="dv">4</span>],
         <span class="dt">end =</span> genesOldCoordsFinal[,<span class="dv">5</span>],
         <span class="dt">originalBuild =</span> <span class="st">&quot;aspFlavusOld.fa&quot;</span>,
         <span class="dt">newBuild =</span> <span class="st">&quot;aspFlavusNew.fa&quot;</span>,
         <span class="dt">tmpdir=</span><span class="kw">getwd</span>(),
         <span class="dt">lengthSides =</span> <span class="dv">100</span>,
         <span class="dt">maxMismatches =</span> <span class="dv">30</span>,
         <span class="dt">aligner=</span><span class="st">&quot;Rsubread&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(<span class="kw">is.na</span>(genesOldInNew$chrom))</code></pre></div>
<pre><code>## [1] 31</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(genesOldInNew$chrom==genesNewCoords$V1 &amp;genesOldInNew$start==genesNewCoords$V4 &amp;<span class="st"> </span>genesOldInNew$end==genesNewCoords$V5,<span class="dt">na.rm =</span> T) /<span class="st"> </span><span class="kw">nrow</span>(genesOldInNew) *<span class="st"> </span><span class="dv">100</span></code></pre></div>
<pre><code>## [1] 98.60441</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(genesOldInNew$chrom!=genesNewCoords$V1 |genesOldInNew$start!=genesNewCoords$V4 &amp;<span class="st"> </span>genesOldInNew$end!=genesNewCoords$V5,<span class="dt">na.rm =</span> T) /<span class="st"> </span><span class="kw">nrow</span>(genesOldInNew) *<span class="st"> </span><span class="dv">100</span></code></pre></div>
<pre><code>## [1] 0.8125577</code></pre>
<p>So it becomes a bit better, and the number of false positives doesnâ€™t change. Another consideration is that there could be a reason regions donâ€™t align, such as being highly repetitive. In such cases, we might not be able to resolve the location with short read realignment.</p>
</div>
<div id="step-5-liftover-with-blastn" class="section level2">
<h2>Step 5: liftoveR with blastn</h2>
<p>Finally, letâ€™s repeat the same analysis with blastn. First thing we need to do it register the blast binaries, as theyâ€™re not currently packaged with <em>liftoveR</em>. <strong>Important Note</strong>: currently, <em>liftoveR</em> supports only the <em>blast+ build 2.2.31+</em>. This is because it requires the SAM output, and the implementation of the SAM output changes with each version of <em>blast+</em>. That version is available to download <a href="ftp://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/2.2.31/">here</a> We specifiy the path to the <em>blastn</em> and <em>makeblastdb</em> executables using the function <em>registerBlast</em>. We also need to specify a path to <em>samtools</em>, which will be used to process the SAM output from <em>blastn</em>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">registerBlast</span>(<span class="st">&quot;/usr/bin/blastn&quot;</span>,<span class="st">&quot;/usr/bin/makeblastdb&quot;</span>,<span class="st">&quot;/usr/bin/samtools&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;blast programs registered&quot;</code></pre>
<p>Now lets run the alignment, this time with <em>blastn</em>. This should take somewhat longer, and multithreading is not currently supported, although again you can enable it by customizing the blastn arguments (see <em>liftover</em> help documentation).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">genesOldInNew =<span class="st"> </span><span class="kw">liftover</span>(<span class="dt">chrom =</span> genesOldCoordsFinal[,<span class="dv">1</span>],
         <span class="dt">start =</span> genesOldCoordsFinal[,<span class="dv">4</span>],
         <span class="dt">end =</span> genesOldCoordsFinal[,<span class="dv">5</span>],
         <span class="dt">originalBuild =</span> <span class="st">&quot;aspFlavusOld.fa&quot;</span>,
         <span class="dt">newBuild =</span> <span class="st">&quot;aspFlavusNew.fa&quot;</span>,
         <span class="dt">tmpdir=</span><span class="kw">getwd</span>(),
         <span class="dt">aligner=</span><span class="st">&quot;blastn&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;Identified 10795 regions that will need to be split due to size&quot;
## Splitting Reads.....10%..20%..30%..40%..50%..60%..70%..80%..90%..100%[1] &quot;building blast database&quot;
## [1] &quot;performing alignment (may take a long time, this IS blast)....&quot;
## [1] &quot;Parsing new start positions based on alignment&quot;
## [1] &quot;Parsing new end positions based on alignment&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(<span class="kw">is.na</span>(genesOldInNew$chrom))</code></pre></div>
<pre><code>## [1] 21</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(genesOldInNew$chrom==genesNewCoords$V1 &amp;genesOldInNew$start==genesNewCoords$V4 &amp;<span class="st"> </span>genesOldInNew$end==genesNewCoords$V5,<span class="dt">na.rm =</span> T) /<span class="st"> </span><span class="kw">nrow</span>(genesOldInNew) *<span class="st"> </span><span class="dv">100</span></code></pre></div>
<pre><code>## [1] 98.549</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(genesOldInNew$chrom!=genesNewCoords$V1 |genesOldInNew$start!=genesNewCoords$V4 &amp;<span class="st"> </span>genesOldInNew$end!=genesNewCoords$V5,<span class="dt">na.rm =</span> T) /<span class="st"> </span><span class="kw">nrow</span>(genesOldInNew) *<span class="st"> </span><span class="dv">100</span></code></pre></div>
<pre><code>## [1] 0.8811502</code></pre>
<p>We are able to get putatively more alignments, but be careful, our error rate also goes up! blast is highly flexible and can align more distantly related sequences, which can result in erroneous alignments.</p>
<p>Letâ€™s get rid of all the temporary files created for this run. Since running the package requires generating indices for alignment, it is recommended to run in a new directory, to be able to clean up afterwards.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">removeDirectory</span>(<span class="st">&quot;aspFlavusNew.fa.Rbowtie&quot;</span>,<span class="dt">recursive =</span> T)
tmpdir =<span class="st"> </span><span class="kw">dir</span>(<span class="dt">pattern=</span><span class="st">&quot;Rtmp&quot;</span>)
<span class="kw">removeDirectory</span>(tmpdir,<span class="dt">recursive =</span> T)
<span class="kw">file.remove</span>(<span class="kw">dir</span>(<span class="dt">pattern=</span><span class="st">&quot;aspFlavus&quot;</span>))
<span class="kw">file.remove</span>(<span class="kw">dir</span>(<span class="dt">pattern=</span><span class="st">&quot;QuasR&quot;</span>))
<span class="kw">file.remove</span>(<span class="kw">dir</span>(<span class="dt">pattern=</span><span class="st">&quot;liftOverInput&quot;</span>))
<span class="kw">file.remove</span>(<span class="kw">dir</span>(<span class="dt">pattern=</span><span class="st">&quot;blast&quot;</span>))</code></pre></div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
